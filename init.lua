 -- luacheck: globals rhynia minetest
local thismod = minetest.get_current_modname()
--local modpath = minetest.get_modpath(thismod)
local tm = thismod
--local parentmod = "rhynia"
local genera = {"canarium"}

for g = 1, #genera do
rhynia.modules[tm] = {genera = {genera[g]}}

local def = {
    parentmod = tm,
    visual = "mesh",
    genus = "canarium",
    root_dim = 2,
    health_max = 10,
    growth_interval = 44,
    substrates = {["nc_tree:tree"] = 4, ["nc_tree:root"]= 6},
    growth_factor = {names = {"nc_fire:ash"},values = {8}},
    survival_factor = {names = {"group:igniter"}, values = {-9}},
    spore_dis_rad = 3,
    condition_factor = {},
    catchments = {base = 1, ext = 2},
    structure = {{"air"},{tm..":canarium_1",tm..":canarium_leaves"},{tm..":canarium_1",tm..":canarium_trunk",tm..":canarium_leaves"}},
    stage = stage,
    traits = {growth_opt = true, pt2condition = true, annual = true},
    acts = {
       on_tick = function(...)
            local val = rhynia.u.selectify(...)
            local pos,genus = val[1], val[2]
            if(not rhynia.f.is_rooted(pos, genera[g]))then return rhynia.u.rn(pos) end
            if(rhynia.f.kill_if_health(pos,0))then return end
            rhynia.f.alter_health(pos,-rhynia.f.spot_check(pos,"group:igniter"))
            
            --local data = rhynia.f.nominate(minetest.get_node(pos).name)
            local function incr()
            rhynia.f.growth_tick(pos,genus)
            end
            incr()
          end
    }
}

rhynia.f.register_emulsion(def)

    local k = genera[g]
    local v = def
    for n = 1, 1 do
            local name = k.."_"..n
            local ndef = {
                genus = k,
                name = tm..":"..name,
                description = k,
                paramtype = "light",
                paramtype2 = "connected",
                sunlight_propagates = true,
                walkable = true,
                drawtype = "nodebox",
                node_box = {
        type = "connected",
        fixed = {
            {-0.1875, -0.5, -0.1875, 0.125, 0.5, 0.1875},
            {0.125, 0.0625, 0.0625, 0.1875, 0.375, 0.125},
            {0.125, -0.3125, -0.0625, 0.1875, 0.125, 0},
            {0.125, -0.3125, 0.125, 0.1875, -0.125, 0.1875},
            {-0.25, -0.3125, 0.0625, -0.1875, -0.125, 0.125},
            {-0.25, -0.1875, -0.125, -0.1875, 0.1875, -0.0625},
            {-0.125, 0.125, -0.25, -0.0625, 0.5, -0.1875},
            {0, -0.5, -0.25, 0.0625, -0.25, -0.1875},
            {-0.125, 0, 0.1875, -0.0625, 0.375, 0.25},
            {0.0625, -0.4375, 0.1875, 0.125, -0.125, 0.25},
        },
    
    connect_top = {
        {-0, 0.375, -0.3125, 0.0625, 0.5, -0.1875},
            {-0, 0.375, 0.1875, 0.0625, 0.5, 0.3125},
            {-0.125, 0.375, 0.1875, -0.0625, 0.5, 0.25},
            {0.1875, 0.375, 0.125, 0.3125, 0.5, 0.1875},
            {0.1875, 0.375, -0.0625, 0.25, 0.5, 0},
            {-0.3125, 0.375, -0.0625, -0.125, 0.5, 0},
            {-0.25, 0.375, 0.0625, -0.125, 0.5, 0.125},
            {-0.25, 0.375, -0.25, -0.0625, 0.5, -0.1875}, 
            {-0.5, 0.4375, -0.25, -0.25, 0.5, -0.1875}, 
            {-0.4375, 0.4375, -0.4375, -0.375, 0.5, -0.25}, 
            {0.0625, 0.4375, -0.3125, 0.3125, 0.5, -0.25}, 
            {0.125, 0.4375, -0.5, 0.1875, 0.5, -0.3125}, -- 
            {0.1875, 0.4375, -0.5, 0.375, 0.5, -0.4375}, -- 
            {-0.125, 0.4375, -0.4375, 0.125, 0.5, -0.375}, 
            {-0.125, 0.4375, -0.375, -0.0625, 0.5, -0.3125},
            {-0.3125, 0.4375, -0.375, -0.125, 0.5, -0.3125}, --
            {-0.25, 0.4375, -0.5, -0.1875, 0.5, -0.375}, -- 
            {0.25, 0.4375, -0.25, 0.5, 0.5, -0.1875}, -- 
            {0.375, 0.4375, -0.25, 0.4375, 0.5, 0}, -- 
            {0.4375, 0.4375, -0.125, 0.5, 0.5, -0.0625}, -- 
            {0.25, 0.4375, 0.1875, 0.3125, 0.5, 0.5}, -- 
            {0.3125, 0.4375, 0.3125, 0.5, 0.5, 0.375}, -- 
            {0.4375, 0.4375, 0.125, 0.5, 0.5, 0.3125}, -- 
            {0.375, 0.4375, 0.375, 0.4375, 0.5, 0.5}, -- 
            {0.0625, 0.4375, 0.4375, 0.25, 0.5, 0.5}, -- 
            {0.125, 0.4375, 0.25, 0.1875, 0.5, 0.4375}, -- 
            {-0.3125, 0.4375, 0.25, -0.0625, 0.5, 0.3125}, -- 
            {-0.3125, 0.4375, 0.3125, -0.25, 0.5, 0.5}, -- 
            {-0.1875, 0.4375, 0.3125, -0.125, 0.5, 0.5}, -- 
            {-0, 0.4375, 0.3125, 0.0625, 0.5, 0.375}, -- 
            {-0.125, 0.4375, 0.375, -0.0625, 0.5, 0.4375}, -- 
            {-0.5, 0.4375, 0.0625, -0.25, 0.5, 0.125}, -- 
            {-0.5, 0.4375, -0.0625, -0.3125, 0.5, 0}, -- 
            {-0.4375, 0.4375, 0.125, -0.375, 0.5, 0.4375}, -- 
            {-0.5, 0.4375, 0.375, -0.4375, 0.5, 0.4375}, -- 
            {-0.5, 0.4375, 0.1875, -0.4375, 0.5, 0.25}, -- 
            {-0.5, 0.4375, -0.125, -0.4375, 0.5, -0.0625}, -- 
            {-0.3125, 0.4375, -0.125, -0.25, 0.5, -0.0625},
            {0.4375, 0.5, -0.3125, 0.5, 0.8125, -0.25}, -- 
            {0.4375, 0.5, -0.125, 0.5, 0.625, -0.0625}, -- 
            {0.4375, 0.5, -0, 0.5, 0.875, 0.0625}, -- 
            {-0.5, 0.5, -0, -0.4375, 0.6875, 0.0625}, -- 
            {-0.5, 0.5, -0.25, -0.4375, 0.8125, -0.1875}, -- 
            {-0.5, 0.5, -0.1875, -0.4375, 0.625, -0.125}, -- 
            {-0.5, 0.5, 0.25, -0.4375, 0.75, 0.3125}, -- 
            {0.3125, 0.5, 0.4375, 0.375, 0.75, 0.5}, -- 
            {0, 0.5, 0.4375, 0.0625, 0.625, 0.5}, -- 
            {-0.1875, 0.5, 0.4375, -0.125, 0.6875, 0.5}, -- 
            {-0.125, 0.5, 0.4375, -0.0625, 0.625, 0.5}, -- 
            {-0.125, 0.5, -0.5, -0.0625, 0.625, -0.4375}, -- 
            {-0.0625, 0.5, -0.5, 0, 0.6875, -0.4375}, -- 
            {0.25, 0.5, -0.5, 0.3125, 0.6875, -0.4375}, -- 
            {-0.3125, 0.5, -0.5, -0.25, 0.8125, -0.4375}, -- 
            {0.4375, 0.5, 0.4375, 0.5, 0.75, 0.5}, -- 
            {0.4375, 0.5, 0.25, 0.5, 0.6875, 0.3125}, -- 
            {0.4375, 0.5, 0.125, 0.5, 0.8125, 0.1875}, -- 
    },
    connect_bottom = {
        {-0.0625, -0.5, -0.3125, 0, -0.375, -0.1875}, -- 
            {-0.0625, -0.5, 0.1875, 0, -0.375, 0.3125}, -- 
            {0.0625, -0.5, 0.1875, 0.125, -0.375, 0.25}, -- 
            {-0.3125, -0.5, 0.125, -0.1875, -0.375, 0.1875}, -- 
            {-0.25, -0.5, -0.0625, -0.1875, -0.375, 0}, -- 
            {0.125, -0.5, -0.0625, 0.3125, -0.375, 0}, -- 
            {0.125, -0.5, 0.0625, 0.25, -0.375, 0.125}, -- 
            {0.0625, -0.5, -0.25, 0.25, -0.375, -0.1875}, -- 
            {0.25, -0.5, -0.25, 0.5, -0.4375, -0.1875}, -- 
            {0.375, -0.5, -0.4375, 0.4375, -0.4375, -0.25}, -- 
            {-0.3125, -0.5, -0.3125, -0.0625, -0.4375, -0.25}, -- 
            {-0.1875, -0.5, -0.5, -0.125, -0.4375, -0.3125}, -- 
            {-0.375, -0.5, -0.5, -0.1875, -0.4375, -0.4375}, -- 
            {-0.125, -0.5, -0.4375, 0.125, -0.4375, -0.375}, -- 
            {0.0625, -0.5, -0.375, 0.125, -0.4375, -0.3125}, -- 
            {0.125, -0.5, -0.375, 0.3125, -0.4375, -0.3125}, -- 
            {0.1875, -0.5, -0.5, 0.25, -0.4375, -0.375}, -- 
            {-0.5, -0.5, -0.25, -0.25, -0.4375, -0.1875}, -- 
            {-0.4375, -0.5, -0.25, -0.375, -0.4375, 0}, -- 
            {-0.5, -0.5, -0.125, -0.4375, -0.4375, -0.0625}, -- 
            {-0.3125, -0.5, 0.1875, -0.25, -0.4375, 0.5}, -- 
            {-0.5, -0.5, 0.3125, -0.3125, -0.4375, 0.375}, -- 
            {-0.5, -0.5, 0.125, -0.4375, -0.4375, 0.3125}, -- 
            {-0.4375, -0.5, 0.375, -0.375, -0.4375, 0.5}, -- 
            {-0.25, -0.5, 0.4375, -0.0625, -0.4375, 0.5}, -- 
            {-0.1875, -0.5, 0.25, -0.125, -0.4375, 0.4375}, -- 
            {0.0625, -0.5, 0.25, 0.3125, -0.4375, 0.3125}, -- 
            {0.25, -0.5, 0.3125, 0.3125, -0.4375, 0.5}, -- 
            {0.125, -0.5, 0.3125, 0.1875, -0.4375, 0.5}, -- 
            {-0.0625, -0.5, 0.3125, 0, -0.4375, 0.375}, -- 
            {0.0625, -0.5, 0.375, 0.125, -0.4375, 0.4375}, -- 
            {0.25, -0.5, 0.0625, 0.5, -0.4375, 0.125}, -- 
            {0.3125, -0.5, -0.0625, 0.5, -0.4375, 0}, -- 
            {0.375, -0.5, 0.125, 0.4375, -0.4375, 0.4375}, -- 
            {0.4375, -0.5, 0.375, 0.5, -0.4375, 0.4375}, -- 
            {0.4375, -0.5, 0.1875, 0.5, -0.4375, 0.25}, -- 
            {0.4375, -0.5, -0.125, 0.5, -0.4375, -0.0625}, -- 
            {0.25, -0.5, -0.125, 0.3125, -0.4375, -0.0625}, -- 
            {0.4375, -0.8125, 0.25, 0.5, -0.5, 0.3125}, -- 
            {0.4375, -0.625, 0.0625, 0.5, -0.5, 0.125}, -- 
            {0.4375, -0.875, -0.0625, 0.5, -0.5, 0}, -- 
            {-0.5, -0.6875, -0.0625, -0.4375, -0.5, 0}, -- 
            {-0.5, -0.8125, 0.1875, -0.4375, -0.5, 0.25}, -- 
            {-0.5, -0.625, 0.125, -0.4375, -0.5, 0.1875}, -- 
            {-0.5, -0.75, -0.3125, -0.4375, -0.5, -0.25}, -- 
            {0.3125, -0.75, -0.5, 0.375, -0.5, -0.4375}, -- 
            {0, -0.625, -0.5, 0.0625, -0.5, -0.4375}, -- 
            {-0.1875, -0.6875, -0.5, -0.125, -0.5, -0.4375}, -- 
            {-0.125, -0.625, -0.5, -0.0625, -0.5, -0.4375}, -- 
            {-0.125, -0.625, 0.4375, -0.0625, -0.5, 0.5}, -- 
            {-0.0625, -0.6875, 0.4375, 0, -0.5, 0.5}, -- 
            {0.25, -0.6875, 0.4375, 0.3125, -0.5, 0.5}, -- 
            {-0.3125, -0.8125, 0.4375, -0.25, -0.5, 0.5}, 
            {0.4375, -0.75, -0.5, 0.5, -0.5, -0.4375},
            {0.4375, -0.6875, -0.3125, 0.5, -0.5, -0.25}, 
            {0.4375, -0.8125, -0.1875, 0.5, -0.5, -0.125},
},},
    connects_to = {"nc_tree:tree", "nc_tree:root","group:canarium_root"},
    connect_sides = {"top", "bottom"},
                tiles = {"canarium_trunk.png","canarium_trunk2.png"},
                groups = {planty = 1, rhynia_plant = 1, choppy = 2,flammable = 8,fire_fuel = 6,log = 1,falling_node = 1,
            scaling_time = 52},
                on_construct = function(pos)
                local meta = minetest.get_meta(pos)
                meta:set_int("rhynia_gl",0)
                meta:set_int("rhynia_ci",1)
                meta:set_int("rhynia_h",v.health_max)
                end,
                on_punch = function(pos)
                    local m = minetest.get_meta(pos)
                    local function shout(s)
                        return rhynia.u.sh(s)
                    end
                    shout("GROWTH: "..m:get_int("rhynia_gi"))
                    shout("CONDITION: "..m:get_int("rhynia_ci"))
                    shout("HEALTH: "..rhynia.f.check_health(pos))
                    shout("LEVEL: "..m:get_int("rhynia_gl"))
                    return
                end
            }
            rhynia.f.rnode(ndef)
        end
        rhynia.f.assign_soils_alt(genera[g])
    end
for n = 1, 2 do
minetest.register_node(tm..":canarium_root_"..n, {
    tiles = minetest.registered_nodes[n == 1 and "nc_tree:root" or "nc_tree:tree"].tiles,
    drawtype = "nodebox",
    paramtype = "light",
    node_box = {
        type = "fixed",
        fixed = {
            {-0.4375, -0.5, -0.4375, 0.4375, 0.5, 0.4375}, -- NodeBox1
        }
    },
    groups = {rhynia = 1, canarium_root = 1, rhynia_plant = 1}
})
end
minetest.register_node(tm..":canarium_leaves", {
    description = "Canarium Leaves",
    drawtype = "nodebox",
    node_box = {
		type = "fixed",
		fixed = {
			{-0.375, -0.5, -0.375, 0.375, 0.375, 0.375}, -- NodeBox1
			{0.375, -0.4375, -0.3125, 0.4375, 0.3125, 0.3125}, -- NodeBox2
			{-0.4375, -0.4375, -0.3125, -0.375, 0.3125, 0.3125}, -- NodeBox3
			{-0.5, -0.375, -0.25, -0.4375, 0.25, 0.25}, -- NodeBox4
			{0.4375, -0.375, -0.25, 0.5, 0.25, 0.25}, -- NodeBox5
			{-0.3125, -0.4375, 0.375, 0.3125, 0.3125, 0.4375}, -- NodeBox6
			{-0.3125, -0.4375, -0.4375, 0.3125, 0.3125, -0.375}, -- NodeBox7
			{-0.25, -0.375, -0.5, 0.25, 0.25, -0.4375}, -- NodeBox8
			{-0.25, -0.375, 0.4375, 0.25, 0.25, 0.5}, -- NodeBox9
			{-0.3125, 0.375, -0.3125, 0.3125, 0.4375, 0.3125}, -- NodeBox10
			{-0.25, 0.4375, -0.25, 0.25, 0.5, 0.25}, -- NodeBox11
		}
	},
    waving = 2,
    tiles = {"canarium_leaves.png"},
    groups = {rhynia = 1, rhynia_plant = 1},
})
minetest.register_node(tm..":canarium_trunk", {
    description = "Canarium Trunk",
    drawtype = "nodebox",
    waving = 1,
    tiles = minetest.registered_nodes[tm..":canarium_1"].tiles,
    node_box = minetest.registered_nodes[tm..":canarium_1"].node_box,
    groups = {rhynia = 1, rhynia_plant = 1},
})

nodecore.register_limited_abm({
    label = "Tree Root Takeover",
    nodenames = {"nc_tree:root","nc_tree:tree"},
    interval = 1,
    chance = 1,
    ignore_stasis = false,
    action = function(pos, node)
    local function airchk(pos)
    	return rhynia.u.gn({x = pos.x, y = pos.y + 1, z = pos.z}).name == "air"
    end
    return airchk(pos) and math.random(100) > 50 and rhynia.u.sna(pos,tm..":canarium_1")
    end
})